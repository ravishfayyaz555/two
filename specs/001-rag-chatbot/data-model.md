# Data Model: RAG Chatbot

**Feature**: 001-rag-chatbot
**Date**: 2025-12-30
**Purpose**: Define data entities, their attributes, and validation rules for RAG chatbot system

## Entities

### ChatQuery

Represents a user's question with context constraints for the RAG chatbot.

**Attributes**:
- `question` (string, required): User's natural language question
- `context` (string, optional): Selected text passage from textbook (for selected-text-only mode)
- `use_context_only` (boolean, required, default: false): Flag to restrict answers ONLY to provided context
- `top_k` (integer, required, default: 5, range: 1-20): Number of relevant chunks to retrieve from vector database
- `chapter_id` (integer, optional): Current chapter context (for chapter-aware mode)

**Validation Rules**:
- `question` must be non-empty string (min length: 3 characters)
- `top_k` must be positive integer between 1 and 20
- `use_context_only` must be boolean
- If `use_context_only` is true, `context` must be non-empty
- If `use_context_only` is false, `context` is ignored (book-wide search)

**Relationships**:
- One-to-one: Each ChatQuery generates one ChatResponse
- No persistence: Queries are transient, not stored permanently

---

### RetrievedChunk

Represents a single piece of textbook content retrieved from vector database.

**Attributes**:
- `chunk_id` (string, required, unique): Unique identifier for the content chunk
- `chapter_id` (integer, required): Chapter number that this chunk belongs to (1-6)
- `section_id` (string, required): Section identifier within the chapter
- `section_title` (string, required): Human-readable title of the section
- `preview_text` (string, required): First 200 characters of chunk content for display in UI
- `full_text` (string, required): Complete content of the chunk (used internally for answer generation)
- `relevance_score` (float, required): Semantic similarity score from vector search (0.0 to 1.0)

**Validation Rules**:
- `chunk_id` must be non-empty unique identifier
- `chapter_id` must be between 1 and 6 (valid textbook chapters)
- `section_id` must be non-empty string
- `preview_text` must not exceed 200 characters
- `relevance_score` must be between 0.0 and 1.0

**Relationships**:
- Many-to-one: Multiple RetrievedChunks belong to one query response
- Source-of-truth: Represents ground truth from textbook (not user-provided)

---

### ChatResponse

Represents the answer generated by the RAG chatbot and returned to the user.

**Attributes**:
- `answer` (string, required): Generated explanation text in educational tone
- `sources` (array of RetrievedChunk, required, max length: 10): Array of relevant chunks used to generate the answer
- `query_time_ms` (integer, required): Time taken to process the query (for monitoring)
- `mode` (enum, required): Answering mode used for this response
  - Values: "book-wide" | "selected-text-only" | "chapter-aware"
- `error` (object, optional): Present only on failure

**Validation Rules**:
- `answer` must be non-empty string (min length: 10 characters, max: 5000 for simple queries)
- `sources` array must contain 1-10 RetrievedChunk objects
- `query_time_ms` must be non-negative integer (in milliseconds)
- `mode` must be one of: "book-wide", "selected-text-only", "chapter-aware"
- If `sources` array is empty and no error present, this indicates "not covered in book" scenario
- `error` structure (when present):
  - `type` (string, required): Error type (e.g., "validation_error", "service_unavailable", "rate_limit_exceeded")
  - `message` (string, required): User-friendly error message

**Relationships**:
- One-to-one: Generated from exactly one ChatQuery
- References: Contains multiple RetrievedChunk entities

---

### SessionMetadata (Future Extension)

Represents session information stored in Neon Serverless Postgres (for future conversation history features).

**Attributes**:
- `session_id` (string, required, unique): Unique session identifier (UUID format)
- `created_at` (datetime, required): Session creation timestamp
- `last_query_at` (datetime, optional): Timestamp of last query in this session
- `query_count` (integer, default: 0): Total number of queries in this session

**Validation Rules**:
- `session_id` must follow UUID v4 format
- `created_at` must be valid ISO 8601 datetime
- `query_count` must be non-negative integer

**Relationships**:
- One-to-many: One SessionMetadata relates to many ChatQuery records
- Transient: No long-term persistence required (optional feature)

## Data Flow

```
User Question (ChatQuery)
    ↓
Vector Search (via Qdrant)
    ↓
Retrieved Chunks (RetrievedChunk[])
    ↓
Answer Generation (via OpenAI Agents SDK)
    ↓
Chat Response (ChatResponse)
    ↓
Displayed to User (with citations)
```

## Storage Strategy

**Qdrant Cloud** (Primary):
- Stores: Vector embeddings (384-dim) for all textbook chunks
- Index Type: HNSW (Hierarchical Navigable Small World)
- Search Method: Cosine similarity
- Query Type: Semantic search

**Neon Serverless Postgres** (Metadata/Sessions):
- Stores: Session metadata for future conversation history
- Stores: Metadata about textbook content (optional extension)
- Purpose: Lightweight metadata store without always-on costs
- Connection Pattern: Serverless (connect per query, no persistent connections)

## State Transitions

Not applicable - entities are stateless for current MVP. Future extensions may introduce conversation state with SessionMetadata.

## Indexes & Optimization

**Qdrant Indexes**:
- Primary index on `chunk_vector` (384-dimensional embeddings)
- Optional: Metadata filters by `chapter_id` and `section_id` for chapter-aware retrieval

**Query Optimization**:
- `top_k` parameter controls retrieval scope vs relevance tradeoff
- Relevance threshold (>0.7) filters low-quality matches
- Chapter metadata enables prioritization of current chapter content

## Schema Version

**Version**: 1.0.0
**Last Updated**: 2025-12-30
